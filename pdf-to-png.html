<!DOCTYPE html>
<html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale = 1.0, maximum-scale = 1.0, user-scalable=no">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
	<script src="pdf.js"></script>
	<script src="pdf.worker.js"></script>
	<script src="images.js"></script>
	<style type="text/css">
		#upload-button {
			width: 150px;
			display: block;
			margin: 20px auto;
		}

		#file-to-upload {
			display: none;
		}

		#pdf-main-container {
			width: 400px;
			margin: 20px auto;
		}

		#pdf-loader {
			display: none;
			text-align: center;
			color: #999999;
			font-size: 13px;
			line-height: 100px;
			height: 100px;
		}

		#pdf-contents {
			display: none;
		}

		#pdf-meta {
			overflow: hidden;
			margin: 0 0 20px 0;
		}

		#pdf-buttons {
			float: left;
		}

		#page-count-container {
			float: right;
		}

		#pdf-current-page {
			display: inline;
		}

		#pdf-total-pages {
			display: inline;
		}

		#pdf-canvas {
			border: 1px solid rgba(0, 0, 0, 0.2);
			box-sizing: border-box;
		}

		#page-loader {
			height: 100px;
			line-height: 100px;
			text-align: center;
			display: none;
			color: #999999;
			font-size: 13px;
		}

		#download-image {
			width: 150px;
			display: block;
			margin: 20px auto 0 auto;
			font-size: 13px;
			text-align: center;
		}
	</style>
</head>

<body>

	<button id="upload-button" href="#">Select PDF</button>
	<button id="clear">Clear</button>
	<input type="file" id="file-to-upload" accept="application/pdf" />

	<div id="pdf-main-container">
		<div id="pdf-loader">Loading document ...</div>
		<div id="pdf-contents">
			<div id="pdf-meta">
				<div id="pdf-buttons">
					<button id="pdf-prev">Previous</button>
					<button id="pdf-next">Next</button>
				</div>
				<div id="page-count-container">Page
					<div id="pdf-current-page"></div> of
					<div id="pdf-total-pages"></div>
				</div>
			</div>
			<canvas id="pdf-canvas" width="400"></canvas>
			<div id="page-loader">Loading page ...</div>
			<a id="download-image" href="#">Download PNG</a>
		</div>
	</div>
	<img id="imgElem"></img>
	<script>
		$(document).ready(function () {

			let pdfUrl = '';
			let imgUrl = '';
			var urlsArr = {
				'pdf': '',
				'img': ''
			};
			var newObj = {};


			var image = new Image();
			var temp;
			$.each(images, function (key, item) {
				var img = document.createElement('img');

				img.src = `${image.src=item}`
				document.body.appendChild(img);
			});

			//Just getting the source from the span. It was messy in JS.

			function createUUID() {
				// http://www.ietf.org/rfc/rfc4122.txt
				var s = [];
				var hexDigits = "0123456789abcdef";
				for (var i = 0; i < 36; i++) {
					s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
				}
				s[14] = "4"; // bits 12-15 of the time_hi_and_version field to 0010
				s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1); // bits 6-7 of the clock_seq_hi_and_reserved to 01
				s[8] = s[13] = s[18] = s[23] = "-";

				var uuid = s.join("");
				return uuid;
			}


			$('#clear').on('click', function () {
				localStorage.clear();
			})
			var __PDF_DOC,
				__CURRENT_PAGE,
				__TOTAL_PAGES,
				__PAGE_RENDERING_IN_PROGRESS = 0,
				__CANVAS = $('#pdf-canvas').get(0),
				__CANVAS_CTX = __CANVAS.getContext('2d');

			function showPDF(pdf_url) {
				$("#pdf-loader").show();

				PDFJS.getDocument({
					url: pdf_url
				}).then(function (pdf_doc) {
					__PDF_DOC = pdf_doc;
					__TOTAL_PAGES = __PDF_DOC.numPages;

					// Hide the pdf loader and show pdf container in HTML
					$("#pdf-loader").hide();
					$("#pdf-contents").show();
					$("#pdf-total-pages").text(__TOTAL_PAGES);

					// Show the first page
					showPage(1);
				}).catch(function (error) {
					// If error re-show the upload button
					$("#pdf-loader").hide();
					$("#upload-button").show();

					alert(error.message);
				});;
			}

			function showPage(page_no) {
				__PAGE_RENDERING_IN_PROGRESS = 1;
				__CURRENT_PAGE = page_no;

				// Disable Prev & Next buttons while page is being loaded
				$("#pdf-next, #pdf-prev").attr('disabled', 'disabled');

				// While page is being rendered hide the canvas and show a loading message
				$("#pdf-canvas").hide();
				$("#page-loader").show();
				$("#download-image").hide();

				// Update current page in HTML
				$("#pdf-current-page").text(page_no);

				// Fetch the page
				__PDF_DOC.getPage(page_no).then(function (page) {
					// As the canvas is of a fixed width we need to set the scale of the viewport accordingly
					var scale_required = __CANVAS.width / page.getViewport(1).width;

					// Get viewport of the page at required scale
					var viewport = page.getViewport(scale_required);

					// Set canvas height
					__CANVAS.height = viewport.height;

					var renderContext = {
						canvasContext: __CANVAS_CTX,
						viewport: viewport
					};

					// Render the page contents in the canvas
					page.render(renderContext).then(function () {
						__PAGE_RENDERING_IN_PROGRESS = 0;

						// Re-enable Prev & Next buttons
						$("#pdf-next, #pdf-prev").removeAttr('disabled');

						// Show the canvas and hide the page loader
						$("#pdf-canvas").show();
						$("#page-loader").hide();
						$("#download-image").show();
					});
				});
			}
			var isUpload;
			// Upon click this should should trigger click on the #file-to-upload file input element
			// This is better than showing the not-good-looking file input element
			$("#upload-button").on('click', function () {
				$("#file-to-upload").trigger('click');

			});

			// When user chooses a PDF file
			$("#file-to-upload").on('change', function () {
				// Validate whether PDF
				if (['application/pdf'].indexOf($("#file-to-upload").get(0).files[0].type) == -1) {
					alert('Error : Not a PDF');

					return;
				}

				//$("#upload-button").attr('href', __CANVAS.toDataURL()).attr('download', 'page.png');
				$("#upload-button").hide();

				// Send the object url of the pdf
				showPDF(URL.createObjectURL($("#file-to-upload").get(0).files[0]));

				$("#download-image").trigger('click');
			});




			// Previous page of the PDF
			$("#pdf-prev").on('click', function () {
				if (__CURRENT_PAGE != 1)
					showPage(--__CURRENT_PAGE);
			});

			// Next page of the PDF
			$("#pdf-next").on('click', function () {
				if (__CURRENT_PAGE != __TOTAL_PAGES)
					showPage(++__CURRENT_PAGE);
			});


			// document.getElementById('button').addEventListener('click', function () {
			// 	var files = document.getElementById('file').files;
			// 	if (files.length > 0) {
			// 		getBase64(files[0]);
			// 	}
			// });

			// function getBase64(file) {
			// 	var reader = new FileReader();
			// 	reader.readAsDataURL(file);
			// 	reader.onload = function () {
			// 		console.log(reader.result);
			// 	};
			// 	reader.onerror = function (error) {
			// 		console.log('Error: ', error);
			// 	};
			// }


			// Download button
			$("#download-image").on("click", function () {
				var files = document.getElementById('file-to-upload').files;
				var pdfUrl = '';
				var reader = new FileReader();
				reader.readAsDataURL(files[0]);
				reader.onload = function () {
					newObj['pdf'] = JSON.stringify();
					pdfUrl = reader.result;
					imgUrl = __CANVAS.toDataURL();
					console.log(reader.result);

					newObj['pdf'] = JSON.stringify(reader.result);
					//newObj['img'] = __CANVAS.toDataURL();
				};
				reader.onerror = function (error) {
					console.log('Error: ', error);
				};



				var obj = JSON.parse(localStorage.getItem('us')) || {};

				obj['pdf'] = 2323;
				localStorage.setItem('us', JSON.stringify(obj));

				var image = new Image();
				//Just getting the source from the span. It was messy in JS.
				image.src = __CANVAS.toDataURL();
				document.body.appendChild(image);

				// imgElem.setAttribute('src', "data:image/jpg;base64," + __CANVAS.toDataURL());

				console.log(JSON.stringify(__CANVAS.toDataURL()))
				$(this).attr('href', __CANVAS.toDataURL()).attr('download', 'page.png');
			});


			var gm = JSON.parse(localStorage.getItem('us'));
			console.log(gm);

		});
	</script>

</body>

</html>